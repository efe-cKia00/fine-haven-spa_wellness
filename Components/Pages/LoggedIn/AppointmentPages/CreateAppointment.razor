@page "/app/appointment/create/{serviceId:int}"
@using CS212FinalProject.Components.Layout
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Microsoft.EntityFrameworkCore
@using CS212FinalProject.Models
@using System.Globalization
@inject AuthenticationStateProvider AuthStateProvider
@inject CS212FinalProject.Data.CS212FinalProjectContext Db
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Create Appointment</PageTitle>

<div class="page">
    <NavMenu />

    <main>
        <article class="content px-4">
            <h1>Book Appointment</h1>
            <hr />

            @if (isLoading)
            {
                <p><em>Loading...</em></p>
            }
            else if (shouldRedirect)
            {
                <p><em>Redirecting...</em></p>
            }
            else if (service == null)
            {
                <p class="text-danger">Service not found.</p>
            }
            else
            {
                <div class="mb-3">
                    <h3>@service.Name</h3>
                    <p>@service.Description</p>
                    <p><strong>Price: @service.Price.ToString("C") / hour</strong></p>
                </div>

                <EditForm Model="appointment" OnValidSubmit="CreateAsync" Enhance>
                    <AntiforgeryToken />
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    @if (isReceptionist)
                    {
                        <div class="mb-3">
                            <label class="form-label">Customer</label>
                            <input type="text" class="form-control mb-2" placeholder="Type customer name..." @bind="customerSearchText" @oninput="OnCustomerSearchInput" />
                            @if (filteredCustomers.Any())
                            {
                                <select class="form-select" size="5" @onchange="OnCustomerSelected">
                                    <option value="">-- Select customer --</option>
                                    @foreach (var c in filteredCustomers)
                                    {
                                        <option value="@c.Id">@c.FirstName @c.LastName (@c.Email)</option>
                                    }
                                </select>
                            }
                            @if (selectedCustomer != null)
                            {
                                <p class="mt-2"><strong>Selected:</strong> @selectedCustomer.FirstName @selectedCustomer.LastName</p>
                            }
                        </div>
                    }

                    <div class="mb-3">
                        <label class="form-label">Date and Time</label>
                        <InputDate class="form-control" @bind-Value="datePart" />
                        <select class="form-control" @bind="timePart">
                            @foreach (var time in AvailableTimes)
                            {
                                <option value="@time">@time</option>
                            }
                        </select>
                    </div>

                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" type="submit">Book Appointment</button>
                        <button class="btn btn-secondary" type="button" @onclick="Cancel">Cancel</button>
                    </div>
                </EditForm>
            }
        </article>
    </main>
</div>

@code {
    [Parameter]
    public int serviceId { get; set; }

    private Service? service;
    private Appointment appointment = new Appointment { Status = StatusType.Pending };
    private bool isLoading = true;
    private bool shouldRedirect = false;
    private bool isReceptionist = false;
    private int? currentUserId;
    private List<String> AvailableTimes = new() { "9:00AM", "10:00AM", "11:00AM", "12:00PM", "1:00PM", "2:00PM", "3:00PM", "4:00PM", "5:00PM" };
    
    // Separate properties for date and time binding
    private DateTime? datePart = DateTime.Now.Date.AddDays(1);
    private string? timePart;

    // Receptionist customer search
    private string customerSearchText = string.Empty;
    private List<User> allCustomers = new();
    private List<User> filteredCustomers = new();
    private User? selectedCustomer;

    protected override async Task OnInitializedAsync()
    {
        timePart = AvailableTimes.FirstOrDefault(); // Set a default time

        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = state.User;

        if (!(user.Identity?.IsAuthenticated ?? false))
        {
            shouldRedirect = true;
            isLoading = false;
            return;
        }

        var role = user.FindFirst(ClaimTypes.Role)?.Value;
        var idClaim = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (int.TryParse(idClaim, out var uid))
            currentUserId = uid;

        // Only Customer or Receptionist can access
        if (role != RoleType.Customer.ToString() && role != RoleType.Receptionist.ToString())
        {
            shouldRedirect = true;
            isLoading = false;
            return;
        }

        isReceptionist = (role == RoleType.Receptionist.ToString());

        service = await Db.Services.FindAsync(serviceId);
        if (service == null)
        {
            isLoading = false;
            return;
        }

        appointment.ServiceId = serviceId;
        appointment.ServiceProviderId = null;
        appointment.Status = StatusType.Pending;

        if (isReceptionist)
        {
            // Load all customers for search
            allCustomers = await Db.Users.Where(u => u.Role == RoleType.Customer).ToListAsync();
        }
        else
        {
            // Customer mode: set customer ID to current user
            appointment.CustomerId = currentUserId ?? 0;
        }

        isLoading = false;
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender && shouldRedirect)
        {
            NavigationManager.NavigateTo("/access-denied");
        }
    }

    private void OnCustomerSearchInput(ChangeEventArgs e)
    {
        customerSearchText = e.Value?.ToString() ?? string.Empty;
        if (string.IsNullOrWhiteSpace(customerSearchText))
        {
            filteredCustomers.Clear();
        }
        else
        {
            var search = customerSearchText.ToLowerInvariant();
            filteredCustomers = allCustomers
                .Where(c => c.FirstName.ToLowerInvariant().Contains(search) || c.LastName.ToLowerInvariant().Contains(search) || c.Email.ToLowerInvariant().Contains(search))
                .Take(10)
                .ToList();
        }
    }

    private void OnCustomerSelected(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var custId) && custId > 0)
        {
            selectedCustomer = allCustomers.FirstOrDefault(c => c.Id == custId);
            appointment.CustomerId = custId;
        }
        else
        {
            selectedCustomer = null;
            appointment.CustomerId = 0;
        }
    }

    private async Task CreateAsync()
    {
        if (service == null || datePart == null || timePart == null) return;

        // Validate customer set
        if (appointment.CustomerId == 0)
        {
            // Optionally show an error message to the user
            return;
        }

        // Combine the date and time
        if (DateTime.TryParseExact(timePart, "h:mmtt", CultureInfo.InvariantCulture, DateTimeStyles.None, out var parsedTime))
        {
            appointment.DateAndTime = datePart.Value.Date + parsedTime.TimeOfDay;
        }
        else
        {
            // Handle parsing error, e.g., show a validation message
            return;
        }

        // Ensure ServiceProviderId is null and Status is Pending
        appointment.ServiceProviderId = null;
        appointment.Status = StatusType.Pending;

        Db.Appointments.Add(appointment);
        await Db.SaveChangesAsync();

        NavigationManager.NavigateTo("/app");
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/app/service-page");
    }
}